{"ast":null,"code":"import { Amplify } from '@aws-amplify/core';\nimport { assertTokenProviderConfig } from '@aws-amplify/core/internals/utils';\nimport { AuthValidationErrorCode } from '../../../errors/types/validation.mjs';\nimport { assertValidationError } from '../../../errors/utils/assertValidationError.mjs';\nimport { assertServiceError } from '../../../errors/utils/assertServiceError.mjs';\nimport { getActiveSignInUsername, getSignInResult, getSignInResultFromError } from '../utils/signInHelpers.mjs';\nimport { autoSignInStore } from '../../../client/utils/store/autoSignInStore.mjs';\nimport { setActiveSignInState, resetActiveSignInState } from '../../../client/utils/store/signInStore.mjs';\nimport { cacheCognitoTokens } from '../tokenProvider/cacheTokens.mjs';\nimport { dispatchSignedInHubEvent } from '../utils/dispatchSignedInHubEvent.mjs';\nimport '../utils/refreshAuthTokens.mjs';\nimport '../tokenProvider/errorHelpers.mjs';\nimport '../utils/types.mjs';\nimport { tokenOrchestrator } from '../tokenProvider/tokenProvider.mjs';\nimport { handleUserAuthFlow } from '../../../client/flows/userAuth/handleUserAuthFlow.mjs';\nimport { getNewDeviceMetadata } from '../utils/getNewDeviceMetadata.mjs';\nimport { resetAutoSignIn } from './autoSignIn.mjs';\n\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n/**\n * Signs a user in through a registered email or phone number without a password by by receiving and entering an OTP.\n *\n * @param input - The SignInWithUserAuthInput object\n * @returns SignInWithUserAuthOutput\n * @throws service: {@link InitiateAuthException }, {@link RespondToAuthChallengeException } - Cognito service errors\n * thrown during the sign-in process.\n * @throws validation: {@link AuthValidationErrorCode  } - Validation errors thrown when either username or password -- needs to change\n *  are not defined.\n * @throws AuthTokenConfigException - Thrown when the token provider config is invalid.\n */\nasync function signInWithUserAuth(input) {\n  const {\n    username,\n    password,\n    options\n  } = input;\n  const authConfig = Amplify.getConfig().Auth?.Cognito;\n  const signInDetails = {\n    loginId: username,\n    authFlowType: 'USER_AUTH'\n  };\n  assertTokenProviderConfig(authConfig);\n  const clientMetaData = options?.clientMetadata;\n  const preferredChallenge = options?.preferredChallenge;\n  assertValidationError(!!username, AuthValidationErrorCode.EmptySignInUsername);\n  try {\n    const handleUserAuthFlowInput = {\n      username,\n      config: authConfig,\n      tokenOrchestrator,\n      clientMetadata: clientMetaData,\n      preferredChallenge,\n      password\n    };\n    const autoSignInStoreState = autoSignInStore.getState();\n    if (autoSignInStoreState.active && autoSignInStoreState.username === username) {\n      handleUserAuthFlowInput.session = autoSignInStoreState.session;\n    }\n    const response = await handleUserAuthFlow(handleUserAuthFlowInput);\n    const activeUsername = getActiveSignInUsername(username);\n    setActiveSignInState({\n      signInSession: response.Session,\n      username: activeUsername,\n      challengeName: response.ChallengeName,\n      signInDetails\n    });\n    if (response.AuthenticationResult) {\n      await cacheCognitoTokens({\n        username: activeUsername,\n        ...response.AuthenticationResult,\n        NewDeviceMetadata: await getNewDeviceMetadata({\n          userPoolId: authConfig.userPoolId,\n          userPoolEndpoint: authConfig.userPoolEndpoint,\n          newDeviceMetadata: response.AuthenticationResult.NewDeviceMetadata,\n          accessToken: response.AuthenticationResult.AccessToken\n        }),\n        signInDetails\n      });\n      resetActiveSignInState();\n      await dispatchSignedInHubEvent();\n      resetAutoSignIn();\n      return {\n        isSignedIn: true,\n        nextStep: {\n          signInStep: 'DONE'\n        }\n      };\n    }\n    return getSignInResult({\n      challengeName: response.ChallengeName,\n      challengeParameters: response.ChallengeParameters,\n      availableChallenges: 'AvailableChallenges' in response ? response.AvailableChallenges : undefined\n    });\n  } catch (error) {\n    resetActiveSignInState();\n    resetAutoSignIn();\n    assertServiceError(error);\n    const result = getSignInResultFromError(error.name);\n    if (result) return result;\n    throw error;\n  }\n}\nexport { signInWithUserAuth };\n//# sourceMappingURL=signInWithUserAuth.mjs.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}